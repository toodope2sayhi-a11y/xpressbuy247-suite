name: Guardian Rollback & Log Sync

on:
  workflow_run:
    workflows:
      - "Auto-Release XpressBuy247 Plugins"
    types: [completed]

jobs:
  rollback:
    name: Verify Release & Rollback if Needed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_CI_TOKEN }}

      - name: Verify release status
        id: check
        run: |
          echo "ðŸ” Checking last release..."
          tag=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' || echo "")
          if [ -z "$tag" ]; then
            echo "No previous release found â€” skipping rollback."
            echo "rollback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Release failed â€” rollback triggered."
            echo "rollback=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… Release healthy."
            echo "rollback=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Execute rollback
        if: steps.check.outputs.rollback == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}
        run: |
          echo "ðŸš¨ Rolling back to last stable release..."
          last_tag=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "Re-publishing $last_tag"
          gh release edit "$last_tag" --prerelease=false --draft=false
          echo "Rollback completed for $last_tag."

      - name: Log result to Guardian Reports
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CI_TOKEN }}
          script: |
            const result = "${{ steps.check.outputs.rollback }}";
            const status = result === "true" ? "âš ï¸ Rollback Executed" : "âœ… Stable Release Verified";
            const body = `
### Guardian Rollback Report
- Workflow: ${context.workflow}
- Result: ${status}
- Time: ${new Date().toISOString()}
- Commit: ${context.payload.workflow_run.head_sha}
- Triggered by: ${context.actor}
`;
            await github.request('POST /repos/${{ github.repository }}/issues', {
              title: `${status} â€” ${context.workflow}`,
              body
            });

  sync-logs:
    name: Sync Guardian Logs Artifact
    needs: rollback
    runs-on: ubuntu-latest
    steps:
      - name: Create log summary
        run: |
          mkdir -p guardian-logs
          echo "Guardian Log Summary â€” $(date)" > guardian-logs/summary.txt
          echo "Workflow: ${{ github.workflow }}" >> guardian-logs/summary.txt
          echo "Run ID: ${{ github.run_id }}" >> guardian-logs/summary.txt
          echo "Result: ${{ github.event.workflow_run.conclusion }}" >> guardian-logs/summary.txt

      - name: Upload Guardian Logs
        uses: actions/upload-artifact@v4
        with:
          name: guardian-logs
          path: guardian-logs/
