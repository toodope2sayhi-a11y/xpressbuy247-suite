name: Guardian Rollback & Log Sync

on:
  workflow_run:
    workflows:
      - "Auto-Release XpressBuy247 Plugins"
    types: [completed]

permissions:
  contents: write
  issues: write

jobs:
  rollback:
    name: Verify Release & Rollback if Needed
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}
        run: |
          gh auth setup-git

      - name: Verify release status
        id: check
        env:
          GH_TOKEN: $${{ secrets.GH_CI_TOKEN }}
        run: |
          echo "ðŸ” Checking last release..."

          LAST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' || true)

          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found. Skipping rollback."
            echo "rollback=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest release: $LAST_TAG"
          echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"

          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Release failed. Triggering rollback."
            echo "rollback=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release healthy."
            echo "rollback=false" >> $GITHUB_OUTPUT
          fi

      - name: Execute rollback
        if: steps.check.outputs.rollback == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}
        run: |
          echo "ðŸš¨ Rolling back to last stable release..."
          LAST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          gh release edit "$LAST_TAG" --prerelease=false --draft=false
          echo "Rollback completed for $LAST_TAG."

  sync-logs:
    name: Sync Guardian Logs Artifact
    needs: rollback
    runs-on: ubuntu-latest

    steps:
      - name: Generate log summary
        run: |
          mkdir -p guardian-logs
          echo "Guardian Log Summary" > guardian-logs/summary.txt
          echo "Date: $(date)" >> guardian-logs/summary.txt
          echo "Workflow: ${{ github.workflow }}" >> guardian-logs/summary.txt
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}" >> guardian-logs/summary.txt
          echo "Commit: ${{ github.event.workflow_run.head_sha }}" >> guardian-logs/summary.txt

      - name: Upload Guardian Logs
        uses: actions/upload-artifact@v4
        with:
          name: guardian-logs
          path: guardian-logs/
