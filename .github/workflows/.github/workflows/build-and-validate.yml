name: Build & Validate XpressBuy247 Plugins

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate and Package Plugins
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_CI_TOKEN }}

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, zip

      - name: Lint and Validate Plugins
        run: |
          echo "ðŸ” Validating plugin files..."
          for plugin in plugins-src/*; do
            [ -d "$plugin" ] || continue
            main_file="$plugin/$(basename "$plugin").php"
            if [[ -f "$main_file" ]]; then
              echo "âœ… Checking $(basename "$plugin")..."
              php -l "$main_file" || exit 1
              grep -q "namespace" "$main_file" || { echo "âŒ Missing namespace in $main_file"; exit 1; }
              grep -q "defined('ABSPATH')" "$main_file" || { echo "âŒ Missing ABSPATH guard in $main_file"; exit 1; }
            else
              echo "âš ï¸ Skipping $(basename "$plugin") â€” main file not found."
            fi
          done

      - name: Package Plugins
        run: |
          mkdir -p build-artifacts
          for plugin in plugins-src/*; do
            [ -d "$plugin" ] || continue
            plugin_slug=$(basename "$plugin")
            main_file="$plugin/$plugin_slug.php"
            if [[ -f "$main_file" ]]; then
              version=$(grep -i "^Version:" "$main_file" | head -n 1 | cut -d':' -f2 | xargs)
              zip_name="${plugin_slug}-v${version}.zip"
              echo "ðŸ“¦ Zipping $plugin_slug ($version)..."
              cd "$plugin"
              zip -r "../../build-artifacts/$zip_name" . -x "*.git*" "*.md" "*tests/*" "*build/*" ".github/*"
              cd - > /dev/null
            fi
          done

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xpressbuy247-validated-plugins
          path: build-artifacts/*.zip

      - name: Notify Build Status by Email
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CI_TOKEN }}
          script: |
            const result = '${{ job.status }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const subject = `ðŸš¦ XpressBuy247 Build ${result === 'success' ? 'Succeeded' : 'Failed'}`;
            const body = `
            Hello Joel,

            The latest build for **XpressBuy247 Suite** has completed with status: **${result.toUpperCase()}**.

            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Run URL: ${runUrl}

            Regards,
            XpressBuy247 Guardian CI
            `;

            await github.request('POST /repos/${{ github.repository }}/issues', {
              title: subject,
              body: body
            });
