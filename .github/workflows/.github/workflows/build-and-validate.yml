name: XpressBuy247 â€¢ Enterprise Build & Validate (Guardian + Sandbox + Watchdog)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: ğŸ” Guardian Validation & Packaging
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}
      BUILD_DIR: build-artifacts
      LOG_DIR: guardian-logs

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_CI_TOKEN }}

      - name: âš™ï¸ Setup PHP Environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, zip, json, curl
          coverage: none

      - name: ğŸ§± Prepare Build & Log Directories
        run: |
          mkdir -p $BUILD_DIR $LOG_DIR
          echo "Guardian Validation Log â€” $(date)" > $LOG_DIR/guardian-validation.log

      - name: ğŸ§  Full Lint & Syntax Check
        run: |
          echo "Running PHP lint on all plugin files..."
          ERRORS=0
          for plugin in plugins-src/*; do
            [ -d "$plugin" ] || continue
            echo "ğŸ” Scanning $(basename "$plugin")..." | tee -a $LOG_DIR/guardian-validation.log
            find "$plugin" -type f -name "*.php" -print0 | while IFS= read -r -d '' file; do
              php -l "$file" 2>> $LOG_DIR/guardian-validation.log || ERRORS=$((ERRORS+1))
            done
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "âŒ Linting failed â€” see guardian-validation.log"
            exit 1
          fi
          echo "âœ… All PHP files linted clean." | tee -a $LOG_DIR/guardian-validation.log

      - name: ğŸ§¾ Validate Headers, Namespace & ABSPATH Guards
        run: |
          echo "Validating headers and namespace consistency..."
          for plugin in plugins-src/*; do
            [ -d "$plugin" ] || continue
            main_file="$plugin/$(basename "$plugin").php"
            if [[ -f "$main_file" ]]; then
              echo "ğŸ“‚ Checking $main_file" | tee -a $LOG_DIR/guardian-validation.log
              grep -q "Plugin Name:" "$main_file" || { echo "âŒ Missing Plugin Header: $main_file" | tee -a $LOG_DIR/guardian-validation.log; exit 1; }
              grep -q "namespace XpressBuy247" "$main_file" || { echo "âŒ Missing Namespace: $main_file" | tee -a $LOG_DIR/guardian-validation.log; exit 1; }
              grep -q "defined('ABSPATH')" "$main_file" || { echo "âŒ Missing ABSPATH Guard: $main_file" | tee -a $LOG_DIR/guardian-validation.log; exit 1; }
            else
              echo "âš ï¸ Skipping $(basename "$plugin") â€” main file not found." | tee -a $LOG_DIR/guardian-validation.log
            fi
          done
          echo "âœ… Header & Namespace Validation Passed." | tee -a $LOG_DIR/guardian-validation.log

      - name: ğŸ“¦ Package Plugins
        run: |
          echo "Zipping validated plugins..."
          for plugin in plugins-src/*; do
            [ -d "$plugin" ] || continue
            plugin_slug=$(basename "$plugin")
            main_file="$plugin/$plugin_slug.php"
            if [[ -f "$main_file" ]]; then
              version=$(grep -i "^Version:" "$main_file" | head -n 1 | cut -d':' -f2 | xargs)
              zip_name="${plugin_slug}-v${version}.zip"
              echo "ğŸ“¦ Building $zip_name" | tee -a $LOG_DIR/guardian-validation.log
              cd "$plugin"
              zip -r "../../$BUILD_DIR/$zip_name" . -x "*.git*" "*.md" "*tests/*" "*build/*" ".github/*" > /dev/null
              cd - > /dev/null
            fi
          done
          echo "âœ… Packaging Complete." | tee -a $LOG_DIR/guardian-validation.log

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xpressbuy247-validated-plugins
          path: build-artifacts/*.zip

      - name: ğŸ§© Upload Guardian Logs
        uses: actions/upload-artifact@v4
        with:
          name: guardian-validation-logs
          path: guardian-logs/*.log

      - name: ğŸ“¨ Notify Build Status
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CI_TOKEN }}
          script: |
            const result = '${{ job.status }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const subject = `ğŸš¦ Guardian Build ${result.toUpperCase()}`
            const body = `Guardian Validation completed for XpressBuy247 Suite.\nStatus: ${result.toUpperCase()}\nRun: ${runUrl}`;
            await github.request('POST /repos/${{ github.repository }}/issues', {
              title: subject,
              body: body
            });

  sandbox:
    name: ğŸ§  Sandbox Safe Activation Test
    runs-on: ubuntu-latest
    needs: validate

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: xpressbuy247-validated-plugins
          path: build-artifacts

      - name: âš™ï¸ Setup WordPress Sandbox
        uses: wearerequired/setup-wp-env@v2
        with:
          php-version: '8.2'
          wp-version: '6.8.3'
          db-host: 127.0.0.1
          db-name: wordpress
          db-user: root
          db-pass: root

      - name: ğŸ“¦ Extract and Activate Plugins
        run: |
          mkdir -p wp-content/plugins/
          for zip in build-artifacts/*.zip; do
            unzip -q "$zip" -d wp-content/plugins/
          done
          echo "Activating all plugins..."
          touch guardian-logs/sandbox-validation.log
          for plugin_dir in wp-content/plugins/*; do
            slug=$(basename "$plugin_dir")
            echo "ğŸ”¹ Activating $slug ..." | tee -a guardian-logs/sandbox-validation.log
            wp plugin activate "$slug" --allow-root || echo "âš ï¸ $slug failed to activate" | tee -a guardian-logs/sandbox-validation.log
          done
          echo "âœ… Sandbox activation cycle complete." | tee -a guardian-logs/sandbox-validation.log

      - name: ğŸ§¾ Generate Guardian Summary JSON
        run: |
          echo '<?php
          $logDir = "guardian-logs";
          $summary = ["timestamp"=>date("Y-m-d H:i:s"),"results"=>[]];
          foreach(["guardian-validation.log","sandbox-validation.log"] as $file){
            $path="$logDir/$file";
            if(!file_exists($path))continue;
            $lines=file($path,FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);
            $plugin=null;
            foreach($lines as $line){
              if(preg_match("/xpressbuy247-[\\w\\-]+/i",$line,$m)){$plugin=$m[0];$summary["results"][$plugin]??=["lint"=>"pending","namespace"=>"pending","sandbox"=>"pending"];}
              if(strpos($line,"linted clean")!==false)$summary["results"][$plugin]["lint"]="passed";
              if(strpos($line,"Header & Namespace Validation Passed")!==false)$summary["results"][$plugin]["namespace"]="passed";
              if(strpos($line,"failed to activate")!==false)$summary["results"][$plugin]["sandbox"]="failed";
              if(strpos($line,"Sandbox activation cycle complete")!==false)$summary["results"][$plugin]["sandbox"]="passed";
            }
          }
          file_put_contents("$logDir/summary.json",json_encode($summary,JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
          echo "âœ… Guardian Summary written to $logDir/summary.json\n";' > builder/guardian-log-parser.php
          php builder/guardian-log-parser.php

      - name: ğŸ“¤ Upload Guardian Summary & Logs
        uses: actions/upload-artifact@v4
        with:
          name: guardian-final-summary
          path: |
            guardian-logs/guardian-validation.log
            guardian-logs/sandbox-validation.log
            guardian-logs/summary.json
