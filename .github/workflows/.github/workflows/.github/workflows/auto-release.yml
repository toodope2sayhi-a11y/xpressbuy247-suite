name: Auto-Release XpressBuy247 Plugins

on:
  workflow_run:
    workflows: ["Build & Validate XpressBuy247 Plugins"]
    types: [completed]

jobs:
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_CI_TOKEN }}

      - name: ðŸ“¥ Download validated plugin ZIPs
        uses: actions/download-artifact@v4
        with:
          name: xpressbuy247-validated-plugins
          path: build-artifacts

      - name: ðŸ“¥ Download Guardian summary & logs
        uses: actions/download-artifact@v4
        with:
          name: guardian-final-summary
          path: guardian-logs

      - name: ðŸ§  Parse Guardian summary for release body
        id: summary
        run: |
          echo "Generating release summary table..."
          if [ -f guardian-logs/summary.json ]; then
            plugins=$(jq -r '.results | to_entries[] | "- **\(.key)** â†’ Lint: \(.value.lint) | Namespace: \(.value.namespace) | Sandbox: \(.value.sandbox)"' guardian-logs/summary.json)
            printf "%s\n" "$plugins" > release-body.md
          else
            echo "_No summary.json found._" > release-body.md
          fi
          cat release-body.md

      - name: ðŸ§® Compute release tag
        id: tag
        run: echo "tag=v${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: ðŸš« Skip if tag already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_CI_TOKEN }}
        run: |
          if gh release view "${{ steps.tag.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸš€ Create GitHub Release (ZIPs + Logs + Summary)
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GH_CI_TOKEN }}
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "XpressBuy247 Suite â€“ ${{ steps.tag.outputs.tag }}"
          body: |
            ðŸ§© **Automated Plugin Release**
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}

            âœ… Validated by Guardian + Sandbox Framework  
            ---
            **Plugin Validation Summary:**  
            $(cat release-body.md)

            ---
            *Logs and summary attached as release assets.*
          draft: false
          prerelease: false
          files: |
            build-artifacts/*.zip
            guardian-logs/guardian-validation.log
            guardian-logs/sandbox-validation.log
            guardian-logs/summary.json

      - name: ðŸ“¨ Post confirmation Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_CI_TOKEN }}
          script: |
            const tag = `${{ steps.tag.outputs.tag }}`;
            const url = `https://github.com/${{ github.repository }}/releases/tag/${tag}`;
            const body = `Hello Joel,

A verified build has been published automatically.

**Tag:** ${tag}  
**URL:** ${url}

All plugin ZIPs, Guardian logs, and Sandbox summary have been attached.  
â€” XpressBuy247 Guardian CI`;
            await github.request('POST /repos/${{ github.repository }}/issues', { title: `ðŸ“¦ Auto-Release Published â€” ${tag}`, body });
