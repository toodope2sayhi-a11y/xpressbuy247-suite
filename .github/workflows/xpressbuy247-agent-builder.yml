name: XpressBuy247 Enterprise Agent Builder ‚Ä¢ 2025 Edition

on:
  workflow_dispatch:
    inputs:
      plugin_folder:
        description: "Folder of the plugin (e.g., xpressbuy247-smart-sandbox-installer-pro)"
        required: true
      plugin_main_file:
        description: "Main plugin file path"
        required: true
      auto_increment:
        description: "Auto-increment version? (yes/no)"
        required: false
        default: "yes"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout Repo
        uses: actions/checkout@v4

      - name: üêò Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: üîç Extract Version from Plugin Header
        id: version
        run: |
          MAIN="${{ github.event.inputs.plugin_main_file }}"
          RAW_VERSION=$(grep -i "Version:" "$MAIN" | head -1 | sed -E 's/Version:\s*//I')
          echo "Raw Version: $RAW_VERSION"
          
          if [ "${{ github.event.inputs.auto_increment }}" = "yes" ]; then
            NEW_VERSION=$(php -r '
              $v = trim("'"$RAW_VERSION"'");
              if (preg_match("/vA\.(\d+)\.(\d+)\.(\d+)/", $v, $m)) {
                  $m[3]++;
                  echo "vA.$m[1].$m[2].$m[3]";
              } else {
                  echo $v;
              }
            ')
          else
            NEW_VERSION="$RAW_VERSION"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: üõ°Ô∏è Guardian Validation ‚Äî Namespace, ABSPATH, Header, BOM
        run: |
          FOLDER="${{ github.event.inputs.plugin_folder }}"
          echo "Running Guardian validation..."
          
          find "$FOLDER" -type f -name '*.php' | while read file; do
            if head -n 1 "$file" | grep -q "<?php"; then :; else
              echo "‚ùå ERROR: File missing opening <?php: $file"; exit 1;
            fi
            if grep -q $'\xEF\xBB\xBF' "$file"; then
              echo "‚ùå ERROR: BOM detected in $file"; exit 1;
            fi
            if ! grep -q "defined('ABSPATH')" "$file"; then
              echo "‚ùå ERROR: ABSPATH check missing: $file"; exit 1;
            fi
          done

      - name: üß† PSR-4 Namespace Validation
        run: |
          FOLDER="${{ github.event.inputs.plugin_folder }}"
          echo "Scanning namespaces..."
          find "$FOLDER" -type f -name '*.php' | while read file; do
            if ! grep -q "^namespace " "$file"; then
              echo "‚ùå ERROR: Missing namespace in $file"; exit 1;
            fi
          done

      - name: üß™ Sandbox Activation Test (WP-CLI)
        run: |
          echo "Setting up WordPress Sandbox..."
          wp core download --allow-root
          wp config create --dbname=wp --dbuser=root --dbpass=root --dbhost=localhost --allow-root
          wp db create --allow-root

          cp -R "${{ github.event.inputs.plugin_folder }}" wp-content/plugins/
          wp plugin activate "${{ github.event.inputs.plugin_folder }}" --allow-root || {
            echo "‚ùå ERROR: Plugin failed to activate"; exit 1;
          }
          echo "Sandbox Activation: ‚úîÔ∏è Success"

      - name: üì¶ Build ZIP
        run: |
          mkdir -p build
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="${{ github.event.inputs.plugin_folder }}-${VERSION}.zip"
          cd "${{ github.workspace }}"
          zip -r "build/$ZIP_NAME" "${{ github.event.inputs.plugin_folder }}"
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"

      - name: üì§ Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: xpressbuy247-plugin-${{ env.ZIP_NAME }}
          path: build/${{ env.ZIP_NAME }}

      - name: üöÄ Auto-Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          files: build/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
