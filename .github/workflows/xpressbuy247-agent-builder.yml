name: XpressBuy247 Agent Builder

on:
  workflow_dispatch:
    inputs:
      plugin_folder:
        description: 'Plugin folder inside the repo (e.g. xpressbuy247-smart-sandbox-installer-pro)'
        required: true
      plugin_main_file:
        description: 'Main plugin file path from repo root (e.g. xpressbuy247-smart-sandbox-installer-pro/xpressbuy247-smart-sandbox-installer-pro.php)'
        required: true
      build_mode:
        description: 'Build mode (dev, staging, enterprise)'
        required: false
        default: 'enterprise'
      version:
        description: 'Version to use in ZIP filename (e.g. vA.0.0.7)'
        required: false
        default: 'dev'

jobs:
  build-plugin:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none

      - name: ‚úÖ PHP syntax check (lint) for all plugin files
        run: |
          PLUGIN_FOLDER="${{ github.event.inputs.plugin_folder }}"
          find "$PLUGIN_FOLDER" -type f -name '*.php' -print0 | xargs -0 -n 1 php -l

      - name: üîç Validate main plugin header
        run: |
          MAIN_FILE="${{ github.event.inputs.plugin_main_file }}"
          if [ ! -f "$MAIN_FILE" ]; then
            echo "Main plugin file not found: $MAIN_FILE" >&2
            exit 1
          fi
          if ! grep -q "Plugin Name:" "$MAIN_FILE"; then
            echo "Plugin header is missing 'Plugin Name:' in $MAIN_FILE" >&2
            exit 1
          fi
          echo "Main plugin header looks OK in $MAIN_FILE"

      - name: üìÅ Prepare build directory
        run: |
          mkdir -p build
          PLUGIN_FOLDER="${{ github.event.inputs.plugin_folder }}"
          cp -R "$PLUGIN_FOLDER" "build/$PLUGIN_FOLDER"

      - name: üì¶ Create plugin ZIP
        run: |
          PLUGIN_FOLDER="${{ github.event.inputs.plugin_folder }}"
          VERSION="${{ github.event.inputs.version }}"
          ZIP_NAME="${PLUGIN_FOLDER}-${VERSION}.zip"
          cd build
          zip -r "$ZIP_NAME" "$PLUGIN_FOLDER"
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"

      - name: ‚¨ÜÔ∏è Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: xpressbuy247-plugin-${{ github.event.inputs.plugin_folder }}-${{ github.event.inputs.version }}
          path: build/${{ env.ZIP_NAME }}
